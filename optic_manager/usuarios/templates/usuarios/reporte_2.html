{% extends "./layout_gerencia.html" %}
{% load mathfilters %}

{% block body %}

<div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="sidebar-sticky pt-3">
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Reportes</span>

            </h6>
            <ul class="nav flex-column reporte">
                <li class="nav-item">
                    <a id="turnos_pacientes" class="nav-link inline-block" href="{% url 'reporte_1' %}">
                        <i id="icon-1" style="vertical-align: middle; text-align: center;"
                            class="fal fa-user-clock feather"></i>
                        Turnos de Pacientes
                    </a>
                </li>
                <li class="nav-item">
                    <a id="pedidos_pacientes" class="nav-link active inline-block" href="#">
                        <i id="icon-2" style="vertical-align: middle; text-align: center;"
                            class="fal fa-prescription feather"></i>
                        Pedidos de Pacientes <span class="sr-only">(current)</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a id="productos_mas_vendidos" class="nav-link inline-block" href="{% url 'reporte_3' %}">
                        <i id="icon-3" style="vertical-align: middle; text-align: center;"
                            class="fal fa-file-invoice-dollar feather"></i>
                        Productos m치s vendidos
                    </a>
                </li>
                <li class="nav-item">
                    <a id="ventas_totales" class="nav-link inline-block" href="{% url 'reporte_4' %}">
                        <i id="icon-4" style="vertical-align: middle; text-align: center;"
                            class="fal fa-cash-register feather"></i>
                        Ventas Totales por Vendedor
                    </a>
                </li>
            </ul>
        </div>
    </nav>
</div>


<main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
    <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Pedidos de pacientes</h1>

        <!-- Button trigger modal -->
        <button type="button" class="btn btn-secondary d-block d-sm-block d-md-none" data-toggle="modal"
            data-target="#exampleModal"><i class="fal fa-file-spreadsheet"></i>
            Ver Reportes
        </button>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Listado de Reportes</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav flex-column reporte">
                            <li class="nav-item">
                                <a id="turnos_pacientes" class="nav-link inline-block"
                                    href="{% url 'reporte_1' %}">
                                    <i id="icon-1" style="vertical-align: middle; text-align: center;"
                                        class="fal fa-user-clock feather"></i>
                                    Turnos de Pacientes
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="pedidos_pacientes" class="nav-link active inline-block" href="#">
                                    <i id="icon-2" style="vertical-align: middle; text-align: center;"
                                        class="fal fa-prescription feather"></i>
                                    Pedidos de Pacientes <span class="sr-only">(current)</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="productos_mas_vendidos" class="nav-link inline-block"
                                    href="{% url 'reporte_3' %}">
                                    <i id="icon-3" style="vertical-align: middle; text-align: center;"
                                        class="fal fa-file-invoice-dollar feather"></i>
                                    Productos m치s vendidos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="ventas_totales" class="nav-link inline-block" href="{% url 'reporte_4' %}">
                                    <i id="icon-4" style="vertical-align: middle; text-align: center;"
                                        class="fal fa-cash-register feather"></i>
                                    Ventas Totales por Vendedor
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar ventana</button>
                    </div>
                </div>
            </div>
        </div>

        <form action="" method="POST">
            {% csrf_token %}


            <div class="row">
                <div class="col-auto">
                    <div class="btn-toolbar mb-2 mb-md-0 dropdown">
                        <label for="inputPeriod">Filtro</label>
                        <select id="inputPeriod" name="periodo" class="form-control" onchange="selection()">
                            <option value="custom">Custom</option>
                            <option value="this-week" selected>Esta Semana</option>
                            <option value="past-week">Semana Anterior</option>
                            <option value="this-month">Este Mes</option>
                            <option value="past-month">Mes Anterior</option>
                            <option value="this-year">Este A침o</option>
                            <option value="past-year">A침o Pasado</option>
                        </select>
                    </div>
                </div>

                <div class="col-auto">
                    <div class="mb-2 mb-md-0">
                        <label for="inputStartDate">Desde</label>
                        <input type="date" name="inputStartDate" id="inputStartDate" class="form-control"
                            onchange="seleccionaCustom()">
                        </input>
                    </div>
                </div>

                <div class="col-auto">
                    <div class="mb-2 mb-md-0">
                        <label for="inputEndDate">Hasta</label>
                        <input type="date" name="inputEndDate" id="inputEndDate" class="form-control"
                            onchange="seleccionaCustom()">
                        </input>
                    </div>
                </div>
            </div>


            <div class="row ml-1 mt-2 mb-2">
                <div class="mb-2 mb-md-0">
                    <button type="submit" id="button_generar_reporte" class="btn btn-primary"><i
                            class="fal fa-file-search"></i> Generar
                        Reporte</button>
                </div>
            </div>

            <!--
            <div class="col-auto">
            <div class="mb-2 mb-md-0">
                <button type="submit" id="button_generar_reporte" class="btn btn-primary">Generar Reporte</button>
            </div> -->
        </form>
    </div>

    <h4>Pacientes y cantidad de pedidos:</h4>
    <div class="table-responsive">
        <table class="table table-striped table-sm" id="tbl">
            <thead>
                <tr>
                    <th>DNI</th>
                    <th>Apellido</th>
                    <th>Nombre</th>
                    <th>Cantidad de pedidos</th>
                </tr>
            </thead>
            <tbody>
                {% for paciente in pacientes%}
                <tr class="row_body" id="tr_{{paciente.id}}">
                    <th scope="row">{{paciente.dni}}</th>
                    <td>{{paciente.apellido}}</td>
                    <td>{{paciente.nombre}}</td>
                    <!-- <td> </td> -->
                </tr>
                {% endfor %}

            </tbody>
        </table>

        <h4 class="mt-5">Listado de pedidos</h4>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID pedido</th>
                        <th>Paciente</th>
                        <th>Producto</th>
                        <th>Fecha y hora</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr class="row_body">
                        <th scope="row" id="id_pedido">{{pedido.id}}</th>
                        <td>{{pedido.paciente.apellido}}, {{pedido.paciente.nombre}} ({{pedido.paciente.dni}})</td>
                        <td>{{pedido.producto.nombre}} ({{pedido.producto.descripcion}})</td>
                        <td>{{pedido.fecha_hora}}</td>
                        <td>{{pedido.cantidad}}</td>
                        <td>{{pedido.cantidad|mul:pedido.precio}}</td>
                        <td>{{pedido.estado}}</td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div><br>
        <footer>
            </br>
            </br>
            </br>
        </footer>

</main>
<!--</div>-->

<script type="text/javascript">
    var periodo = `{{periodo}}`
    console.log(periodo)

    function sortTable() {
        var tbl = document.getElementById("tbl").tBodies[0];
        var store = [];
        for (var i = 0, len = tbl.rows.length; i < len; i++) {
            var row = tbl.rows[i];
            var sortnr = parseFloat(row.cells[3].textContent || row.cells[3].innerText);
            if (!isNaN(sortnr)) store.push([sortnr, row]);
        }
        store.sort(function (x, y) {
            return x[0] - y[0];
        });
        for (var i = 1, len = store.length; i <= len; i++) {
            tbl.appendChild(store[len - i][1]);
        }
        store = null;
        console.log("Tabla ordenada")
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("inputPeriod").value = periodo;
        if (`{{primer_rep}}` == "True") {
            document.getElementById("button_generar_reporte").click();
        } else {
            var desde = `{{fecha_desde}}`
            console.log(desde)
            var hasta = `{{fecha_hasta}}`
            console.log(hasta)
            document.getElementById("inputStartDate").value = desde;
            document.getElementById("inputEndDate").value = hasta;
        }
        var trs = document.querySelectorAll(".row_body")
        for (var id in {
                {
                    pedidos_pac
                }
            }) {
            tr = document.getElementById(`tr_${id}`)
            console.log(tr)
            console.log(id)
            var cant = {
                {
                    pedidos_pac
                }
            } [id]
            console.log(cant)
            td = document.createElement("td")
            td.innerHTML = cant;
            tr.appendChild(td)
        }
        sortTable();
    })
</script>

{% endblock %}